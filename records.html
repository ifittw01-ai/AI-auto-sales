<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客戶資料紀錄 - AI自動引客系統</title>
    <link rel="stylesheet" href="styles.css">
    <!-- SheetJS 用於生成 Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .records-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .records-header h1 {
            font-size: 28px;
            color: #333;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .stats-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
        }

        .stats-box h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            opacity: 0.9;
        }

        .stats-box .count {
            font-size: 48px;
            font-weight: bold;
            margin: 0;
        }

        .info-message {
            background: #e7f3ff;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0d47a1;
        }

        .info-message strong {
            display: block;
            margin-bottom: 5px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background-color: #f8f9ff;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-data-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .device-info {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .device-info strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .records-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-buttons {
                width: 100%;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .table-container {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="records-container">
        <div class="records-header">
            <h1>📊 客戶資料紀錄</h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="exportToExcel()">
                    📥 匯出 Excel
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    🗑️ 清除所有資料
                </button>
                <a href="setup.html" class="btn btn-secondary">
                    ⚙️ 系統設定
                </a>
                <a href="index.html" class="btn btn-secondary">
                    ← 返回首頁
                </a>
            </div>
        </div>

        <div class="device-info">
            <strong>💡 提示：</strong>
            此資料儲存在您目前使用的設備和瀏覽器中。不同設備或瀏覽器的資料是獨立的，不會互相共用。
        </div>

        <div class="stats-box">
            <h2>本設備已儲存的客戶資料</h2>
            <p class="count" id="totalCount">0</p>
            <p>筆資料</p>
        </div>

        <div class="info-message" id="infoMessage" style="display: none;">
            <strong>ℹ️ 資訊</strong>
            <span id="infoText"></span>
        </div>

        <div class="table-container" id="tableContainer" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>姓名</th>
                        <th>電子郵件</th>
                        <th>電話</th>
                        <th>國家/地區</th>
                        <th>行業</th>
                        <th>評估地區</th>
                        <th>LINE ID</th>
                        <th>WhatsApp</th>
                        <th>訂閱電子報</th>
                        <th>建立時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <div id="noDataState" class="no-data">
            <div class="no-data-icon">📭</div>
            <p>目前沒有客戶資料</p>
            <p><a href="index.html" class="btn btn-primary" style="margin-top: 20px;">開始收集資料</a></p>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'customerLeads';

        // 載入資料
        function loadData() {
            try {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                displayData(data);
                return data;
            } catch (error) {
                console.error('載入資料失敗:', error);
                showInfo('載入資料時發生錯誤');
                return [];
            }
        }

        // 顯示資料
        function displayData(data) {
            const tbody = document.getElementById('dataTableBody');
            const tableContainer = document.getElementById('tableContainer');
            const noDataState = document.getElementById('noDataState');
            const totalCount = document.getElementById('totalCount');

            totalCount.textContent = data.length;

            if (data.length === 0) {
                tableContainer.style.display = 'none';
                noDataState.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            noDataState.style.display = 'none';

            tbody.innerHTML = data.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${escapeHtml(item.fullName)}</td>
                    <td>${escapeHtml(item.email)}</td>
                    <td>${escapeHtml(item.phone)}</td>
                    <td>${getCountryName(item.country)}</td>
                    <td>${getIndustryName(item.industry)}</td>
                    <td>${getRegionName(item.region)}</td>
                    <td>${escapeHtml(item.lineId || '未提供')}</td>
                    <td>${escapeHtml(item.whatsapp || '未提供')}</td>
                    <td>${item.newsletter ? '是' : '否'}</td>
                    <td>${formatDateTime(item.createdAt)}</td>
                    <td>
                        <button class="action-btn" onclick="deleteItem(${item.id})">
                            刪除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 匯出 Excel
        function exportToExcel() {
            const data = loadData();

            if (data.length === 0) {
                alert('沒有資料可以匯出');
                return;
            }

            // 準備 Excel 資料
            const excelData = data.map((item, index) => ({
                '序號': index + 1,
                '姓名': item.fullName,
                '電子郵件': item.email,
                '電話': item.phone,
                '國家/地區': getCountryName(item.country),
                '行業': getIndustryName(item.industry),
                '評估地區': getRegionName(item.region),
                'LINE ID': item.lineId || '未提供',
                'WhatsApp': item.whatsapp || '未提供',
                '訂閱電子報': item.newsletter ? '是' : '否',
                '建立時間': formatDateTime(item.createdAt)
            }));

            // 建立工作表
            const ws = XLSX.utils.json_to_sheet(excelData);

            // 設定欄位寬度
            ws['!cols'] = [
                { wch: 6 },  // 序號
                { wch: 15 }, // 姓名
                { wch: 25 }, // 電子郵件
                { wch: 15 }, // 電話
                { wch: 12 }, // 國家
                { wch: 20 }, // 行業
                { wch: 12 }, // 評估地區
                { wch: 18 }, // LINE ID
                { wch: 18 }, // WhatsApp
                { wch: 12 }, // 訂閱
                { wch: 20 }  // 時間
            ];

            // 建立工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '客戶資料');

            // 生成檔案名稱
            const fileName = `客戶資料_${new Date().toISOString().split('T')[0]}.xlsx`;

            // 匯出檔案
            XLSX.writeFile(wb, fileName);

            showInfo(`✅ 已成功匯出 ${data.length} 筆資料到 ${fileName}`);
        }

        // 刪除單筆資料
        function deleteItem(id) {
            if (!confirm('確定要刪除這筆資料嗎？')) {
                return;
            }

            try {
                let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                data = data.filter(item => item.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                
                loadData();
                showInfo('✅ 資料已刪除');
            } catch (error) {
                console.error('刪除失敗:', error);
                alert('刪除失敗，請稍後再試');
            }
        }

        // 清除所有資料
        function clearAllData() {
            const data = loadData();
            
            if (data.length === 0) {
                alert('目前沒有資料可以清除');
                return;
            }

            if (!confirm(`確定要清除所有 ${data.length} 筆資料嗎？\n\n此操作無法復原！\n建議先匯出 Excel 備份。`)) {
                return;
            }

            try {
                localStorage.removeItem(STORAGE_KEY);
                loadData();
                showInfo('✅ 所有資料已清除');
            } catch (error) {
                console.error('清除失敗:', error);
                alert('清除失敗，請稍後再試');
            }
        }

        // 顯示訊息
        function showInfo(text) {
            const infoMessage = document.getElementById('infoMessage');
            const infoText = document.getElementById('infoText');
            
            infoText.textContent = text;
            infoMessage.style.display = 'block';

            setTimeout(() => {
                infoMessage.style.display = 'none';
            }, 5000);
        }

        // 工具函數
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getCountryName(code) {
            const countries = {
                'TW': '台灣',
                'HK': '香港',
                'SG': '新加坡',
                'MY': '馬來西亞',
                'CN': '中國',
                'US': '美國',
                'other': '其他'
            };
            return countries[code] || code;
        }

        function getIndustryName(code) {
            const industries = {
                'spiritual': '身心靈導師',
                'beauty': '美容 / 美髮',
                'education': '教育 / 培訓',
                'insurance': '保險 / 金融',
                'realestate': '房地產',
                'consultant': '諮詢顧問',
                'freelancer': '自由工作者',
                'coach': '個人教練',
                'ecommerce': '電商 / 微商',
                'other': '其他'
            };
            return industries[code] || code;
        }

        function getRegionName(code) {
            const regions = {
                'north': '北部',
                'central': '中部',
                'south': '南部'
            };
            return regions[code] || (code || '未提供');
        }

        // 頁面載入時載入資料
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>

